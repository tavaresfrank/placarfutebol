<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle do Placar</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 5px; padding: 8px; font-size: 16px; }
    .linha { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>Controle do Placar</h1>

  <div class="linha">
    <label>Time A: <input type="text" id="timeA" value="Time A"></label>
    <button onclick="mudarPlacar('A',1)">+1</button>
    <button onclick="mudarPlacar('A',-1)">-1</button>
    <span id="golsA">0</span>
  </div>

  <div class="linha">
    <label>Time B: <input type="text" id="timeB" value="Time B"></label>
    <button onclick="mudarPlacar('B',1)">+1</button>
    <button onclick="mudarPlacar('B',-1)">-1</button>
    <span id="golsB">0</span>
  </div>

  <div class="linha">
    <label>Min: <input type="number" id="minutos" value="0"></label>
    <label>Seg: <input type="number" id="segundos" value="0"></label>
  </div>
  
  <div class="linha">
    <button onclick="iniciarTempo()">Start</button>
    <button onclick="pausarTempo()">Pause</button>
    <button onclick="reiniciarTempo()">Reset</button>
  </div>

  <script>
    let golsA = 0, golsB = 0;
    let timerInterval = null;

    // Função para carregar os dados salvos do servidor
    async function carregarDados() {
      try {
        const res = await fetch("/dados");
        const dados = await res.json();
        
        golsA = dados.golsA;
        golsB = dados.golsB;
        document.getElementById("golsA").textContent = golsA;
        document.getElementById("golsB").textContent = golsB;
        document.getElementById("timeA").value = dados.timeA;
        document.getElementById("timeB").value = dados.timeB;
        document.getElementById("minutos").value = dados.minutos;
        document.getElementById("segundos").value = dados.segundos;

        // Se o jogo estava rodando, reinicia o timer do controle
        if (dados.rodando && !timerInterval) {
            iniciarContagemNoControle();
        }
      } catch (e) {
        console.error("Erro ao carregar dados", e);
      }
    }

    window.onload = carregarDados;

    // Envia apenas o estado do placar (gols e nomes)
    function mudarPlacar(time, valor) {
      if(time === "A") {
        golsA = Math.max(0, golsA + valor);
        document.getElementById("golsA").textContent = golsA;
      } else {
        golsB = Math.max(0, golsB + valor);
        document.getElementById("golsB").textContent = golsB;
      }
      enviarDados();
    }

    // Escuta a mudança nos campos de nome para atualizar em tempo real
    document.getElementById("timeA").addEventListener("input", enviarDados);
    document.getElementById("timeB").addEventListener("input", enviarDados);

    // Função central para enviar dados
    async function enviarDados(opcoes = {}) {
      const dados = {
        timeA: document.getElementById("timeA").value,
        golsA: golsA,
        timeB: document.getElementById("timeB").value,
        golsB: golsB,
        minutos: parseInt(document.getElementById("minutos").value),
        segundos: parseInt(document.getElementById("segundos").value),
        rodando: opcoes.rodando,
        reset: opcoes.reset
      };

      try {
        await fetch("/dados", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados),
        });
      } catch (e) {
        console.error("Erro ao salvar dados", e);
      }
    }
    
    // Funções para controle do tempo
    function iniciarTempo() {
        enviarDados({ rodando: true });
        iniciarContagemNoControle();
    }

    function pausarTempo() {
        enviarDados({ rodando: false });
        clearInterval(timerInterval);
        timerInterval = null;
    }

    function reiniciarTempo() {
        pausarTempo();
        document.getElementById("minutos").value = 0;
        document.getElementById("segundos").value = 0;
        enviarDados({ rodando: false, reset: true });
    }
    
    function iniciarContagemNoControle() {
        if (timerInterval) return; // Não inicia se já estiver rodando
        timerInterval = setInterval(() => {
            let min = parseInt(document.getElementById("minutos").value);
            let seg = parseInt(document.getElementById("segundos").value);
            seg++;
            if (seg === 60) {
                seg = 0;
                min++;
            }
            document.getElementById("minutos").value = min;
            document.getElementById("segundos").value = seg;
            enviarDados(); // Envia o tempo atualizado a cada segundo
        }, 1000);
    }

  </script>
</body>
</html>